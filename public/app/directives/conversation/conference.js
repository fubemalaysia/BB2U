/*conference*/
var conference=function(e){function n(){T=e.openSocket({onmessage:o,callback:function(e){T=e}})}function o(n){n.userToken!=c.userToken&&(m&&n.roomToken&&n.broadcaster&&e.onRoomFound(n),n.newParticipant&&c.joinedARoom&&c.broadcasterid==n.userToken&&i(n.newParticipant),n.userToken&&n.joinUser==c.userToken&&n.participant&&-1==u.indexOf(n.userToken)&&(u+=n.userToken+"--",r({isofferer:!0,channel:n.channel||n.userToken})),n.left&&e.onRoomClosed&&e.onRoomClosed(n))}function r(n){function o(e){e?(v.offerSDP=e,v.onAnswerSDP=a):v.onOfferSDP=a,l=RTCPeerConnection(v)}function r(){f=!0,e.onRemoteStream&&e.onRemoteStream({video:h,stream:n.stream}),d&&u.split("--").length>3&&T.send({newParticipant:p.channel,userToken:c.userToken})}function t(){return navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i)?r():void(h.readyState<=HTMLMediaElement.HAVE_CURRENT_DATA||h.paused||h.currentTime<=0?setTimeout(t,50):r())}function a(e){p.send({userToken:c.userToken,sdp:JSON.stringify(e)})}function i(e){e.userToken!=c.userToken&&(e.sdp&&(R.sdp=JSON.parse(e.sdp),s()),e.candidate&&!f&&(l?l.addICE({sdpMLineIndex:e.candidate.sdpMLineIndex,candidate:JSON.parse(e.candidate.candidate)}):console.error("missed an ice",e.candidate)),e.left&&l&&l.peer&&(l.peer.close(),l.peer=null))}function s(){E||(E=!0,S?l.addAnswerSDP(R.sdp):o(R.sdp))}if(n.channel){var m={channel:n.channel,onmessage:i,onopen:function(){S&&!l&&o(),k[k.length]=p}};m.callback=function(e){p=e,this.onopen()};var f,l,p=e.openSocket(m),S=n.isofferer,h=document.createElement("video"),R={},v={attachStream:e.attachStream,onICE:function(e){p.send({userToken:c.userToken,candidate:{sdpMLineIndex:e.sdpMLineIndex,candidate:JSON.stringify(e.candidate)}})},onRemoteStream:function(e){e&&(h[moz?"mozSrcObject":"src"]=moz?e:webkitURL.createObjectURL(e),h.play(),n.stream=e,t())},onRemoteStreamEnded:function(n){e.onRemoteStreamEnded&&e.onRemoteStreamEnded(n,h)}},E=!1}}function t(){for(var n=k.length,o=0;n>o;o++){var r=k[o];r&&(r.send({left:!0,userToken:c.userToken}),delete k[o])}d&&T.send({left:!0,userToken:c.userToken,roomToken:c.roomToken}),e.attachStream&&e.attachStream.stop()}function a(e){T&&T.send({roomToken:c.roomToken,roomName:c.roomName,broadcaster:c.userToken}),e||setTimeout(a,3e3)}function i(e){if(e&&-1==u.indexOf(e)&&e!=c.userToken){u+=e+"--";var n=s();r({channel:n}),T.send({participant:!0,userToken:c.userToken,joinUser:e,channel:n})}}function s(){var e=function(){return Math.floor(65536*Math.random()).toString(16)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var d,c={userToken:s()},u="--",m=!0,k=[],T={};return window.addEventListener("beforeunload",function(){t()},!1),window.addEventListener("keyup",function(e){116==e.keyCode&&t()},!1),n(),{createRoom:function(e){e=e||{},c.roomName=e.roomName||"Anonymous",c.roomToken=e.roomToken||s(),e.userToken&&(c.userToken=e.userToken),d=!0,m=!1,a(e.transmitRoomOnce)},joinRoom:function(e){e=e||{},c.roomToken=e.roomToken,m=!1,c.joinedARoom=!0,c.broadcasterid=e.joinUser,r({channel:c.userToken}),T.send({participant:!0,userToken:c.userToken,roomToken:c.roomToken,joinUser:e.joinUser})},leaveRoom:t}};
/*RTCPeerConnection*/
function RTCPeerConnection(e){function n(){e.onOfferSDP&&S.createOffer(function(n){n.sdp=a(n.sdp),S.setLocalDescription(n),e.onOfferSDP(n),console.debug("offer-sdp",n.sdp)},l,b)}function o(){e.onAnswerSDP&&(console.debug("offer-sdp",e.offerSDP.sdp),S.setRemoteDescription(new f(e.offerSDP),c,l),S.createAnswer(function(n){n.sdp=a(n.sdp),S.setLocalDescription(n),e.onAnswerSDP(n),console.debug("answer-sdp",n.sdp)},l,b))}function a(e){return moz||!z?e:(e=e.replace(/b=AS([^\r\n]+\r\n)/g,""),z.audio&&(e=e.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+z.audio+"\r\n")),z.video&&(e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+z.video+"\r\n")),z.data&&(e=e.replace(/a=mid:data\r\n/g,"a=mid:data\r\nb=AS:"+z.data+"\r\n")),e)}function r(){!e.onChannelMessage||moz&&!e.onOfferSDP||(t(),moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(e){S.addStream(e),n()},d))}function t(){w=S.createDataChannel(e.channel||"RTCDataChannel",moz?{}:{reliable:!1}),moz&&(w.binaryType="blob"),i()}function i(){w.onmessage=function(n){e.onChannelMessage&&e.onChannelMessage(n)},w.onopen=function(){e.onChannelOpened&&e.onChannelOpened(w)},w.onclose=function(n){e.onChannelClosed&&e.onChannelClosed(n),console.warn("WebRTC DataChannel closed",n)},w.onerror=function(n){e.onChannelError&&e.onChannelError(n),console.error("WebRTC DataChannel error",n)}}function s(){S.ondatachannel=function(e){w=e.channel,w.binaryType="blob",i()},moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(e){S.addStream(e),o()},d)}function d(){console.error("Error in fake:true")}function c(){}function l(e){var n=JSON.stringify(e,null,"	");-1!=n.indexOf("RTP/SAVPF Expects at least 4 fields")&&(n="It seems that you are trying to interop RTP-datachannels with SCTP. It is not supported!"),console.error("onSdpError:",n)}var u=window,m=u.mozRTCPeerConnection||u.webkitRTCPeerConnection,f=u.mozRTCSessionDescription||u.RTCSessionDescription,p=u.mozRTCIceCandidate||u.RTCIceCandidate,h=[];moz&&(h.push({url:"stun:23.21.150.121"}),h.push({url:"stun:stun.services.mozilla.com"})),moz||(h.push({url:"stun:stun.l.google.com:19302"}),h.push({url:"stun:stun.anyfirewall.com:3478"})),!moz&&28>chromeVersion&&h.push({url:"turn:homeo@turn.bistri.com:80",credential:"homeo"}),!moz&&chromeVersion>=28&&(h.push({url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"}),h.push({url:"turn:turn.anyfirewall.com:443?transport=tcp",credential:"webrtc",username:"webrtc"})),e.iceServers&&(h=e.iceServers),h={iceServers:h},console.debug("ice-servers",JSON.stringify(h.iceServers,null,"	"));var g={optional:[]};moz||(g.optional=[{DtlsSrtpKeyAgreement:!0}],e.onChannelMessage&&(g.optional=[{RtpDataChannels:!0}])),console.debug("optional-arguments",JSON.stringify(g.optional,null,"	"));var S=new m(h,g);if(r(),S.onicecandidate=function(n){n.candidate&&e.onICE(n.candidate)},e.attachStream&&S.addStream(e.attachStream),e.attachStreams&&e.attachStream.length)for(var C=e.attachStreams,v=0;v<C.length;v++)S.addStream(C[v]);S.onaddstream=function(n){var o=n.stream;o.onended=function(){e.onRemoteStreamEnded&&e.onRemoteStreamEnded(o)},e.onRemoteStream&&e.onRemoteStream(o),console.debug("on:add:stream",o)};var b=e.constraints||{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};console.debug("sdp-constraints",JSON.stringify(b.mandatory,null,"	")),(e.onChannelMessage&&!moz||!e.onChannelMessage)&&(n(),o());var w,z=e.bandwidth;return e.onAnswerSDP&&moz&&e.onChannelMessage&&s(),{addAnswerSDP:function(e){console.debug("adding answer-sdp",e.sdp),S.setRemoteDescription(new f(e),c,l)},addICE:function(e){S.addIceCandidate(new p({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate})),console.debug("adding-ice",e.candidate)},peer:S,channel:w,sendData:function(e){w&&w.send(e)}}}function getUserMedia(e){function n(n){var a=e.video;a&&(a[moz?"mozSrcObject":"src"]=moz?n:window.webkitURL.createObjectURL(n),a.play()),e.onsuccess&&e.onsuccess(n),o=n}var o,a=navigator;return a.getMedia=a.webkitGetUserMedia||a.mozGetUserMedia,a.getMedia(e.constraints||{audio:!0,video:video_constraints},n,e.onerror||function(e){console.error(e)}),o}window.moz=!!navigator.mozGetUserMedia;var chromeVersion=navigator.mozGetUserMedia?0:parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),video_constraints={mandatory:{},optional:[]};
/*GetMedia Element*/
function getMediaElement(e,t){function o(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function n(){document.fullscreen&&document.cancelFullScreen(),document.mozFullScreen&&document.mozCancelFullScreen(),document.webkitIsFullScreen&&document.webkitCancelFullScreen()}function i(e){if(e.srcElement==l){var o=document.webkitIsFullScreen||document.mozFullScreen||document.fullscreen;l.style.width=(o?window.innerWidth-20:t.width)+"px",l.style.display=o?"block":"inline-block",t.height&&(x.style.height=(o?window.innerHeight-20:t.height)+"px"),!o&&t.onZoomout&&t.onZoomout(),o&&t.onZoomin&&t.onZoomin(),o||-1==y.className.indexOf("zoom-out")||(y.className=y.className.replace("zoom-out selected","zoom-in"),t.onZoomout&&t.onZoomout()),setTimeout(a,1e3)}}function a(){s.style.marginLeft=l.clientWidth-s.clientWidth-2+"px",N?(N.style.width=l.clientWidth/3+"px",h.style.marginLeft=l.clientWidth/3-30+"px",y&&(y.style["border-top-right-radius"]="5px")):h.style.marginLeft=l.clientWidth-h.clientWidth-2+"px",h.style.marginTop=l.clientHeight-h.clientHeight-2+"px",10>w?(w++,setTimeout(a,1e3)):w=0}if(t=t||{},!e.nodeName||"audio"!=e.nodeName.toLowerCase()&&"video"!=e.nodeName.toLowerCase()){if(!e.getVideoTracks().length)return getAudioElement(e,t);var d=e;e=document.createElement(d.getVideoTracks().length?"video":"audio"),e[navigator.mozGetUserMedia?"mozSrcObject":"src"]=navigator.mozGetUserMedia?d:window.webkitURL.createObjectURL(d)}if(e.nodeName&&"audio"==e.nodeName.toLowerCase())return getAudioElement(e,t);e.controls=!1;var c=t.buttons||["mute-audio","mute-video","full-screen","volume-slider","stop"];c.has=function(e){return-1!==c.indexOf(e)},t.toggle=t.toggle||[],t.toggle.has=function(e){return-1!==t.toggle.indexOf(e)};var l=document.createElement("div");l.className="media-container";var s=document.createElement("div");if(s.className="media-controls",l.appendChild(s),c.has("mute-audio")){var r=document.createElement("div");r.className="control "+(t.toggle.has("mute-audio")?"unmute-audio selected":"mute-audio"),s.appendChild(r),r.onclick=function(){-1!=r.className.indexOf("unmute-audio")?(r.className=r.className.replace("unmute-audio selected","mute-audio"),e.muted=!1,e.volume=1,t.onUnMuted&&t.onUnMuted("audio")):(r.className=r.className.replace("mute-audio","unmute-audio selected"),e.muted=!0,e.volume=0,t.onMuted&&t.onMuted("audio"))}}if(c.has("mute-video")){var u=document.createElement("div");u.className="control "+(t.toggle.has("mute-video")?"unmute-video selected":"mute-video"),s.appendChild(u),u.onclick=function(){-1!=u.className.indexOf("unmute-video")?(u.className=u.className.replace("unmute-video selected","mute-video"),e.muted=!1,e.volume=1,e.play(),t.onUnMuted&&t.onUnMuted("video")):(u.className=u.className.replace("mute-video","unmute-video selected"),e.muted=!0,e.volume=0,e.pause(),t.onMuted&&t.onMuted("video"))}}if(c.has("take-snapshot")){var m=document.createElement("div");m.className="control take-snapshot",s.appendChild(m),m.onclick=function(){t.onTakeSnapshot&&t.onTakeSnapshot()}}if(c.has("stop")){var p=document.createElement("div");p.className="control stop",s.appendChild(p),p.onclick=function(){l.style.opacity=0,setTimeout(function(){l.parentNode&&l.parentNode.removeChild(l)},800),t.onStopped&&t.onStopped()}}var h=document.createElement("div");if(h.className="volume-control",c.has("record-audio")){var g=document.createElement("div");g.className="control "+(t.toggle.has("record-audio")?"stop-recording-audio selected":"record-audio"),h.appendChild(g),g.onclick=function(){-1!=g.className.indexOf("stop-recording-audio")?(g.className=g.className.replace("stop-recording-audio selected","record-audio"),t.onRecordingStopped&&t.onRecordingStopped("audio")):(g.className=g.className.replace("record-audio","stop-recording-audio selected"),t.onRecordingStarted&&t.onRecordingStarted("audio"))}}if(c.has("record-video")){var v=document.createElement("div");v.className="control "+(t.toggle.has("record-video")?"stop-recording-video selected":"record-video"),h.appendChild(v),v.onclick=function(){-1!=v.className.indexOf("stop-recording-video")?(v.className=v.className.replace("stop-recording-video selected","record-video"),t.onRecordingStopped&&t.onRecordingStopped("video")):(v.className=v.className.replace("record-video","stop-recording-video selected"),t.onRecordingStarted&&t.onRecordingStarted("video"))}}if(c.has("volume-slider")){var f=document.createElement("div");f.className="control volume-slider",h.appendChild(f);var N=document.createElement("input");N.type="range",N.min=0,N.max=100,N.value=100,N.onchange=function(){e.volume="."+N.value.toString().substr(0,1)},f.appendChild(N)}if(c.has("full-screen")){var y=document.createElement("div");y.className="control "+(t.toggle.has("zoom-in")?"zoom-out selected":"zoom-in"),N||g||v||!y?h.appendChild(y):s.insertBefore(y,s.firstChild),y.onclick=function(){-1!=y.className.indexOf("zoom-out")?(y.className=y.className.replace("zoom-out selected","zoom-in"),n()):(y.className=y.className.replace("zoom-in","zoom-out selected"),o(l))},document.addEventListener("fullscreenchange",i,!1),document.addEventListener("mozfullscreenchange",i,!1),document.addEventListener("webkitfullscreenchange",i,!1)}(c.has("volume-slider")||c.has("full-screen")||c.has("record-audio")||c.has("record-video"))&&l.appendChild(h);var x=document.createElement("div");x.className="media-box",l.appendChild(x),x.appendChild(e),t.width||(t.width=innerWidth/2-50),l.style.width=t.width+"px",t.height&&(x.style.height=t.height+"px"),x.querySelector("video").style.maxHeight=innerHeight+"px";var w=0;return t.showOnMouseEnter||"undefined"==typeof t.showOnMouseEnter?(l.onmouseenter=l.onmousedown=function(){a(),s.style.opacity=1,h.style.opacity=1},l.onmouseleave=function(){s.style.opacity=0,h.style.opacity=0}):setTimeout(function(){a(),setTimeout(function(){s.style.opacity=1,h.style.opacity=1},300)},700),a(),l.toggle=function(e){if("string"==typeof e)return"mute-audio"==e&&r&&r.onclick(),"mute-video"==e&&u&&u.onclick(),"record-audio"==e&&g&&g.onclick(),"record-video"==e&&v&&v.onclick(),"stop"==e&&p&&p.onclick(),this;for(var t=0;t<e.length;t++)l.toggle(e[t])},l.media=e,l}function getAudioElement(e,t){function o(){a.style.marginLeft=i.clientWidth-a.clientWidth-7+"px",a.style.marginTop=i.clientHeight-a.clientHeight-6+"px",10>p?(p++,setTimeout(o,1e3)):p=0}if(t=t||{},!e.nodeName||"audio"!=e.nodeName.toLowerCase()&&"video"!=e.nodeName.toLowerCase()){var n=e;e=document.createElement("audio"),e[navigator.mozGetUserMedia?"mozSrcObject":"src"]=navigator.mozGetUserMedia?n:window.webkitURL.createObjectURL(n)}t.toggle=t.toggle||[],t.toggle.has=function(e){return-1!==t.toggle.indexOf(e)},e.controls=!1,e.play();var i=document.createElement("div");i.className="media-container";var a=document.createElement("div");a.className="media-controls",i.appendChild(a);var d=document.createElement("div");if(d.className="control "+(t.toggle.has("mute-audio")?"unmute-audio selected":"mute-audio"),a.appendChild(d),d.style["border-top-left-radius"]="5px",d.onclick=function(){-1!=d.className.indexOf("unmute-audio")?(d.className=d.className.replace("unmute-audio selected","mute-audio"),e.muted=!1,t.onUnMuted&&t.onUnMuted("audio")):(d.className=d.className.replace("mute-audio","unmute-audio selected"),e.muted=!0,t.onMuted&&t.onMuted("audio"))},!t.buttons||t.buttons&&-1!=t.buttons.indexOf("record-audio")){var c=document.createElement("div");c.className="control "+(t.toggle.has("record-audio")?"stop-recording-audio selected":"record-audio"),a.appendChild(c),c.onclick=function(){-1!=c.className.indexOf("stop-recording-audio")?(c.className=c.className.replace("stop-recording-audio selected","record-audio"),t.onRecordingStopped&&t.onRecordingStopped("audio")):(c.className=c.className.replace("record-audio","stop-recording-audio selected"),t.onRecordingStarted&&t.onRecordingStarted("audio"))}}var l=document.createElement("div");l.className="control volume-slider",l.style.width="auto",a.appendChild(l);var s=document.createElement("input");s.style.marginTop="11px",s.style.width=" 200px",t.buttons&&-1==t.buttons.indexOf("record-audio")&&(s.style.width=" 241px"),s.type="range",s.min=0,s.max=100,s.value=100,s.onchange=function(){e.volume="."+s.value.toString().substr(0,1)},l.appendChild(s);var r=document.createElement("div");r.className="control stop",a.appendChild(r),r.onclick=function(){i.style.opacity=0,setTimeout(function(){i.parentNode&&i.parentNode.removeChild(i)},800),t.onStopped&&t.onStopped()},r.style["border-top-right-radius"]="5px",r.style["border-bottom-right-radius"]="5px";var u=document.createElement("div");u.className="media-box",i.appendChild(u);var m=document.createElement("h2");m.innerHTML=t.title||"Audio Element",m.setAttribute("style","position: absolute;color: rgb(160, 160, 160);font-size: 20px;text-shadow: 1px 1px rgb(255, 255, 255);padding:0;margin:0;"),u.appendChild(m),u.appendChild(e),i.style.width="329px",u.style.height="90px",m.style.width=i.style.width,m.style.height="50px",m.style.overflow="hidden";var p=0;return t.showOnMouseEnter||"undefined"==typeof t.showOnMouseEnter?(i.onmouseenter=i.onmousedown=function(){o(),a.style.opacity=1},i.onmouseleave=function(){a.style.opacity=0}):setTimeout(function(){o(),setTimeout(function(){a.style.opacity=1},300)},700),o(),i.toggle=function(e){if("string"==typeof e)return"mute-audio"==e&&d&&d.onclick(),"record-audio"==e&&c&&c.onclick(),"stop"==e&&r&&r.onclick(),this;for(var t=0;t<e.length;t++)i.toggle(e[t])},i.media=e,i}
/*initReliableSignaler*/
function initReliableSignaler(n,e,i){function o(){s&&n&&n.isInitiator&&n.roomid&&s.emit("keep-session",n.roomid),s=io.connect(e||"",i),s.on("connect",function(){s.isHavingError&&o()}),s.on("message",function(n){c[n.channel]&&c[n.channel](n.message)}),s.on("error",function(){s.isHavingError=!0,o()}),s.on("disconnect",function(){s.isHavingError=!0,o()})}function r(n,e){window.removeEventListener(n,e),window.addEventListener(n,e,!1)}function t(){return navigator.onLine?void(s.isHavingError&&o()):void console.warn("Internet channel seems disconnected.")}function a(){if(window.crypto&&window.crypto.getRandomValues&&-1===navigator.userAgent.indexOf("Safari")){for(var n=window.crypto.getRandomValues(new Uint32Array(3)),e="",i=0,o=n.length;o>i;i++)e+=n[i].toString(36);return e}return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}var s;if(!n)throw'"connection" argument is required.';o();var c={};return n.openSignalingChannel=function(e){var i=e.channel||this.channel||"default-channel";return c[i]=e.onmessage,e.onopen&&setTimeout(e.onopen,1),{send:function(e){s.emit("message",{sender:n.userid,channel:i,message:e})},channel:i}},r("load",t),r("online",t),r("offline",t),{socket:s,createNewRoomOnServer:function(e,i){n.roomid=e,n.isInitiator=!0,n.userid=n.userid||a(),s.emit("keep-in-server",e||n.channel,i||function(){})},getRoomFromServer:function(e,i){n.userid=n.userid||a(),s.emit("get-session-info",e,i)}}}